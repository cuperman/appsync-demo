AWSTemplateFormatVersion: 2010-09-09
Description: AppSync Demo Master Stack
Parameters:
  DomainName:
    Type: String
  ValidationDomainName:
    Type: String
    Default: ''
Outputs:
  UiStackId:
    Value: !Ref UiStack
  UiBucketName:
    Value: !GetAtt UiStack.Outputs.SiteBucketId
  UiUrl:
    Value: !GetAtt UiStack.Outputs.SiteCloudFrontDomain
  StorageStackId:
    Value: !Ref StorageStack
  UsersStackId:
    Value: !Ref UsersStack
  ApiStackId:
    Value: !Ref ApiStack
  ApiUrl:
    Value: !GetAtt ApiStack.Outputs.GraphqlApiUrl
Resources:
  UiStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./ui.yml
      Parameters:
        DomainName: !Ref DomainName
        ValidationDomainName: !Ref ValidationDomainName
  StorageStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./storage.yml
  UsersStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./users.yml
  ApiStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - StorageStack
      - UsersStack
    Properties:
      TemplateURL: ./api.yml
      Parameters:
        DataAccessPolicyArn: !GetAtt StorageStack.Outputs.DataAccessPolicyArn
        EventsTableName: !GetAtt StorageStack.Outputs.EventsTableName
        CommentsTableName: !GetAtt StorageStack.Outputs.CommentsTableName
        UserPoolId: !GetAtt UsersStack.Outputs.UserPoolId
